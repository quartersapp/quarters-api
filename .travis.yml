language: node_js
node_js:
- 8.3.0
cache:
  directories:
  - node_modules
addons:
  postgresql: '9.6'
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - gcc-4.8
    - g++-4.8
  code_climate:
    repo_token: $CODE_CLIMATE_TOKEN
branches:
  only:
  - master
before_script:
- psql -c 'create database quarters_test;' -U postgres
- psql -c "CREATE USER root;" -U postgres
- npm run migrate-test
script: CI=true npm t
after_success:
  - npm install -g codeclimate-test-reporter
  - codeclimate-test-reporter < ./coverage/lcov.info
env:
  global:
  - NODE_ENV=staging
  # LAMBDA_FUNCTION_NAME
  - secure: Ixj05lgD+eiiVF7aXBJiuDap4qxSVtTVrG5WBt94F2JPk3ast1jpWzhQ2pQDdpreL/HSiecXRrS1ESP3ThOLqjsG2rXdCG9FzJa+DhQX5IvMESw+ppy85uvdFJjPYuZeUMVozuv3/BCVyLMn+QXtMgINI3Zl+AmNlNtyfW8X97s0rw2WZxFAaqJTgy29ETW9/ovUJSAbHVHQ8e4FhjapV0ocXUhEZzEbm5B0hrIOsuVoP7Knsr3EFyKZXp+jwCiBUMpR8j09GZ57T0UucyPfoAbbwMrsr/+yrBFzrLJFLxfslgORqKhM9Kl2V5WQtY8O3UoBMKV2X/kPbXTwfMQ+6+0Dvi6QMikBQkerYktOSxFRsQAm3Z0aIm6AXjGz384U2Pc/Qm9tLg2RKfSPcSZIrMYlpPsA3HeE7zk88fdMa1ZgB7fyzrVbpa9UF8c0htaIDCVHxcsZdOtaWGf5TR3U+nYGSeM1akD7htHxqLT9IcA5YXZCIJ1RueWNnnliDZkWcGSliQ72W0rSTD/Xf136f9I/9Unxk+0YyWPxa/Lx0ehsrufs9GYbJd9fmsdKiPKBe/lu70qRnXGQ3PIM3G59yUaot1AW58FWm1qQvl9OD/5vvM+bjPsc/9PLqucHSMoRZ3N00hxf6za5PQONKT8gnIUHRDHzpNAx/D5j1Vavn40=
  # LAMBDA_REGION
  - secure: R2dQcw0R1OfpJYOKqeQW+PO84tLYcQPNGBUyAUpd+9OonVSoW6CKAtFNH5gaY19UvH29wS0qY6SzM0aGxi2OzSNItH9Pb2veUuYAe5OEk1UuKtSQYGkx61B7jkbNAJelGNISSWeHVHVVp2gVZUko5N6xOG2PE9yfe1xwiWwMS1Ae7aad5/J1CuVanfDTVrn3FjRLoUWhXtJVe0RsxtqXaYXJOHIiyMSycaG3M5vdUBluCUYCQzc2Pd4lWIhFXtsz3lHg07645OkBh1dTIm8p6scZ+iQMfE3p/AgCVv3+esEwoHombFs7htKJQebVemnewvFJkt7kN8aa/jyzWE31uf00lR7TTNzAyIAJW8odfDqy9DlIfxDmN6muyZ8SfHXGu0Wt3NmqZexTdvJgiVfBVwHEKRIB0s6EEL2U8+TyzJa3BzdnjIWxO+OxqQgMa3DDjzghzvt/+/HduHSHRuSaUlcvfKJwdDcKUDmG/gp5PZWfSiHPax3/JTYLGmLeFzj6YggN5Q6fjQexeKCXG5o6Z8Hh99Pr2Lze4jsujoBeLkdoljMY3t5O0wwPYt4rOIqlXuos1FCajv2rg0EwGcEKiOz7sovwwNY0Hm8L3jbNJgrM0/SammqhBljtsogmLy9Lg/2jwfCkEbOilnWpZmG+3M1ur9NhLz3nP0WJ5jNJj60=
  # LAMBDA_ROLE
  - secure: f6Tuo3Pk2v40or9ROtLw0s4mTJ1LstZC8XeAbm7Hp1GDkQ5yMyOoKUT8UOTpYs9BjRKrVCosCZ5dlT3sEtjDj2sv13NEb7AMUZbqJ8JYR2WcZBNn/sKAl3j7SVDVc5G1+cj+e6synbagibtEESMpu9wXRjC4GEJCJYyy02pwDdWsANA2UzW10wvmEBeD7rTYMW37PNNtmt2cKGjJQopzA09TUjBWyxghCYiGTHq2HDWvFKf4BPH4RzW2Il2l33KSZU8/zT69vG5tFyxJ+gL3T7oqdj+1S94JAVx6YN7Mjp38hdfO2pphLbO6p5On5zkTWPgr4EU921tmRm9pP8UauQbK3ysHACuplotIeBicN6dQ4zsQ3rAYqVhktp+nBJnnqA7OeQK1QrztroyyUb71JzXZenjN8SnTe5FL5ZiCYd3wJZn8cs5ouPCdJ/JuNIrnTE5KY/onkSqPFQnOAZ4DJkyxXqP5BKomodDasM9X+L1HH3fPquELQHmiWdPqnL8s4DbRAkyg+gKG+/yhMYu8KJa7S7D63f1DJ/fmePLKeoOWnAOGeSL7JQ8I45h+0hvYqt+o9tX8X76tE0jbmNRHXpc++tab5G/XCbMoahUSAaPLMGpyBhvpghyDrtJiP+dxgFUe/eVTdG1mDeuHoR1HHDB6qS4XbkN0HOTQFMlRuc0=
  # AWS_ACCESS_KEY
  - secure: V5Fc5ARTSo5lS0WkKWVcPZ9D2shDCCuYxycjcOHhiivTtAO6jpeN/TLCrq5R6tVqCxQiu7iXPEvZscxG4Q30tvjF8lzfw40waNbcDb+T1z3nZDbi3I2x5h1YXfBcTqoUeeXm7qjOE9a/3eFA9LeHdPvMKJByoLwGNe4wVl/mNOB3jqhRhxv1Hii1OGhx3nhldm71MWbqm9W7H7b3N9xszdI7o5yVpWWxbqctA3GEgRSxWxm9cFPY2NZXS4GydLOnpyibh6RiBQ/lA7WGdJKg4KlgO2N2SnMi2HUZO/fJNw2RjzYTNw/K7dbc9zrOJv4NSRfED6KR7sVMjt9mkrcqHSLgm41wm3D6HzDDi7UWejx1NRJftrbPQq+4gbU/izs9yzuvVo/6U/0tj3g6e8FvhSyJe+aC4zLhI00BvYoSLmTtsqiWzSD82cKRzMGKKmI4z3bpD8Ai52oI3fzYrsYA9S7aU4P2u9mtJoZt0Z3hOdudVIxqwzqBtDJaKsZQSK7H2tGTVFBu++8YgqwRxh8UB8P56A/zxtKolxnDGm553Uwa3cGee6lSQarRtGjM0E2oTbFLvpN5UCw2neDkeYmrdHrP96MP/tRWP7bgvtfa2PBL0JNuz+FX6xYl44JgWr9QX+FI++lwlMy3Olp9XNrUVroyKMIbh00hXAGXXgqryo8=
  #AWS_SECRET_ACCESS_KEY
  - secure: EVkSb0IeqYi9NMRojI6tSmieQtwj3J2yHTXZQbpp1oQHp8XomFDOouumYaAcQGNes+WN1V2jnzgbycBzhzyihTmOcGxPZGzlAKaPqyOZ0RmoNdT5zzToWVvmWhpfmOhjEqIwpGCCow5S+D/VoL5NOLTERKKRc/L/E3qfajP+fERv3JF123RwYyWh09CxiG5XfudAzfKLoYlR9Cdw74P4imi5g/tKr3zq3WE6fkWqzmC4dFu8Xxp4Ytb+vex67x3IuhFS1P3x25IDMyRGs0b5FErkadaJmG/CMDzW5UV/TWhtTwLFGnLY/U3a94at/f+J3ADcHi5s/sCGWlwjoSUPuD6D1X+DcSWNIeT9Wel3pIYCau28mTmWBq5gwVMvAIHiHiOxdsUUPXmkOi32xCAiDcjn8m+n5ig2BRJORfxErUCWo9VSQz2NvM6MSTRcUV9pEWlfopgIfZ5Zvr89P/qpaYdTgYqrCNF0vWUZSV+NdvTrgwyp30om0ZnvtC2r9qMykHFHwA7gGDumg4p34/6Cvuch0/fN6hr4U4ZlMIXjeTQI2NoHCchKtjSQfkzsOhArDG32Z/nO1M7WLK/qPkrPmg2tN0WF1w44SHy8RrVlFjg6dodyrgfwny4JvgLt3InfncHlvY1w1lTyPJLVSvSlJYrsOxeUqn0Ey4BdggoUfXY=
  # DB_HOST
  - secure: eRkB8Roiibw1p9qsczyHo7V5MsWAW9N9A5sP1KBRHT2behz4SAlu6nmcBGYT10wHZy6TTat5FuYQcA57KdNHg2RrQ9yQpHGn87t+vEABKq/2NLdyq6zlmDDeiBsgYk1Vvxt5cjDjDu6p1a75fXdydZNAWBCSd8UU8fZKOuQt2gaR6exxXN0XnwlLmn4HywDQ682HvwVbw/2Zu41AMkaxYVp6OzXu1VnjMKxnLSUcZwG8ZnOdpmfwvZ/ApM+lEmjGuHMBwAqP20/ZT7TcgIgJJgBWTziCFRKjBIwvO4wxhN5RvRJNNr0r3memcqUI89/1cXmaERQeUUZ6kLkMipp2Vuw9e4x/g4QKGdbBPiafr2SEGJMp3EkPLgvpjkVT/EoO9+Sijz0SVdr8tPDEY2Gp93c5VdKhp1G+xzJOzijsTgtr7BHiGUVAE1USRZlnVP6ly12mF29qLkduDjcRgvQQ5MYciMJnVT5FI11UbkEmsblHxcP4lmIJy0oVP45mrZDdfaS57no8HP0cgKSLvezIlt4cEO+cYtZ3xDrEzZWbztbHkWsBU5qLKGn57M72CH/kCtgLiqt1q/81244E2hyFDA+1uu/4TYaeodOpK4w18pMte4pZlLe/+HapBr3nZKL0htNO60ECxWnuSrnR+sUQaCEeSfRMHUAkBnoYE716rAA=
  # DB_PASSWORD
  - secure: Vj2f7dztfNU2lwCUYn/M8+u/ErZYoBqIvS6sQP5dR9XvTMLgKQObM3oZ/fRLscS48qATIkanXmF3CnczoLrosb5QfbOud3mBuP/hnzSduXrmiWrliSQGvKbIMlHEZeKIdVZiUZrWoJBfgKxVjkhl7sBl5uhSAbav9CgTGxl1RjeQnarflk/bPwTVDwfjyv2CSo3H8S1EQwugQLEP058CCvZRjPnQT/GwN1MiXkyNbNW2swMVfSk+e/MQin1a55sJXtUyGvSVt0J+FVidrCs70S0TpPUmvFM+aeuIDkGdHWeSggIgcYxXZfYQ1EF8HBRFZPBdWyjreYWPm1lL10lMVGYw8+k84T+p93PqY/+lfwpk4qZ9bKkcEAcXSXeKTRokGP3nTWks64NFjVP8TMKzNVckROnPr/O4Urb5e6x8FbGvKGu8xK29Dj0hBgWE+6DZgQahNj35riO9kY++4h4faJKSTv72vZcWaVx4jj/jsykK7dBOL+sKWU7f8dcXVIPOyb3J83cjv9l7LTT+w1nIw3nQK8I6+o1VWXSNizPm/1UTzkme+74dWw9GO8tU4NwJpEQL7ps65VFaLtgNU1SiBq/5V0Vs/Z7zE1wp7EAGMKYey/jsJfPldedmQsJHOFTqiO/ovZEotfdkDmk8ZsD7iMxBgeKJLrQ6Lsgb/hTraBo=
  # DB_USERNAME
  - secure: cly8mz3lRMlQpppwqzEZtmSg1bgUTiKcVi0MhQ1ICGdn2noUEu8jzsxqsCobuc/UR6xnFRxw6fg9Gl5MnQEzhFRsvfI9eqa9oPlWpL2gtqKCF9/FSA9EpiCBZdjI/gZ5Rt59fAHL3Mn91Pz0OakDTtBD77Cftmviydwsfx3jD2oVGn33ahDSzidMpdXtzqlYCOLcayT+rxrhIZmbRJfxs6f/AXPvaTxdPMQbuvY1z5CY90nkizJYaaatC5hUAcSfTe7iUPDK2Ih8k4L32lGdHJjbXuwZP/vCkGsMpMqa3WsQibHlVqitaJ2hKxic0mlSP8SHP1wH325uyszaaCiapFmeXTBCg4TQtCGIxMnWEC4Mh//UR+DgCQcebdN0lO6+0whZy7Qe3/g1WoMVXtYDAdds2BCT3pOBHWSUPpGNToNrTF+k1u54Y/m/dJPaZvAx5kCKJM/i1Axdt57x0kCAzUXvYZUCXpHZkrHNhPj38SvYrWOpWmPIhnO16PQrEyGCg3LTqQQXRR0Xzxp4qRIYGAdd1xOmP9+bnR8itiYUCDLxKZ4yLnEr6zHdTr3fqH40r6K5pgUzEONoU4ma8sDBEM9ntYwgp3U00QDvDg/gzbJeKsmd1lwMWMQE8AMOdGK5Pwq+Qk724JTK+eW5JXe0RoDphw9XOZ8a/dEcuLsZ4SA=
  # DB_NAME
  - secure: l58E7IaTzQQOUxzQhTv4ryd34JWS4QEAWry11MMVBp07cGO3KKGje9NoUrLmHUscUKV3I/9cDh3zF/7jqbZhZc7q7KP+DnuMIGNn4/dNqimRQCy5ZGtGFFmLJfIWtBPw7h+5TtWSbCO6q4s7KUH/5eZN4MNFTRWYpAxW4kAitwtyyxPjLLepX1NmBXuwzOek5HRIOHn2RHZTKOAM+47BjYGWUvdcLIrNHSQoCHakjhV35db10XtLVzWukoNVqGMYRucEmmgwAy9CbiqkG9nbJXV15gGvjjvKf0BElQf5hO8ey1gZPR3zQ4qYLbLJH3zH02Ub+CXCEq+6QwRb3hD0EnuR3OgZ0EMFenEYdKaAiQdBcu55GMy9LwvZfsX/LhEhv5Og1vfYQnLEuBF9BU1WC2hkQg2d3F6907Q5d6b2QaxluUdgKa6KBWo0VHL4P78flpu3zPUbFy4lg6tHYaQNpWOWbm7yMI1SpCy4AADuqudtEZblrfkB5Q2jhQjr6QvWWaTWVwa1U6nd0FVeFBvPDgC4BnM4+JVD9HOR8QJAYYY6PuEysJPrSQhjdmmohgG8MN9av9qZPAbReCfbf2ru6hlIyg6OU8M03yIJ18+cdMhTFfmFJZoOsgHD3HHT1GkULJiE5ofWI4ujxqyY6EB6PS1ku/PQFwl6R9jBK2b+NTk=
  # CODE_CLIMATE_TOKEN
  - secure: UQA/ZpV5mPv2iKPga34iyDMHyd2Dnw6LMAJFESbzWV16jaUNnqsxKuJTxAdAoBAGLSawyYFSRIDf8QT3qC9ywWUDWt9Nzs4uUAPrWuaF6ZRuolJlI3NuAgeoTburz04IelVK7BwMELRy2bKARvHNMx+d+/ah6JhpW+uNjp2rOEFCWdcJrhMeMwdywsQDs0VmF6a14asEif4LseHuSD+q7ktD/inGjYV89WvrKQCErmYWMlNd0g1R58kYddbunyUICv06oePSDHB4f6bxSHkwPnOvfWPeqJvG6RMd/x4AK+F3PY5rmb1YjAxaJJ4ZG7eu039JbGk8wSVA4dEWd/K9Af60gNPMD7ARVCIYiVNTH7mmS82QjVx49+lAbhm+jBsO+EXgSfP+Z/SlFeZYHx06n4wFqnbRcyUIeLZFbMCKztXWI2o22tX5hcZ/oQU3wtz3LUfjQi5Y0DhVTimXJ9jmtZTmRfBSc9x0++/iHMGdUFqJ9PNfurAkq2GXUVvQmonkc5D88C0zgbSmJWkUJLQMEeNBgu2psrLxQovKs2w6FRTWCC8F+7B9stj5ZAe4RQs6dkhHm7Nx6ZUArB5xiFz9M+fSOkRD3x6TwCmwwOZLB08ukeoY/j9qsjie6BO6CrVQQS+SB9PfhsGMsouwFKxVIQfcwqOPgdOVWv6CKGtV/JY=
before_deploy:
- "./node_modules/.bin/webpack"
- DATABASE_HOST=$DB_HOST DATABASE_USER=$DB_USERNAME DATABASE_PASSWORD=$DB_PASSWORD
  DATABASE_NAME=$DB_NAME npm run migrate
deploy:
  provider: lambda
  function_name: "$LAMBDA_FUNCTION_NAME"
  region: "$LAMBDA_REGION"
  role: "$LAMBDA_ROLE"
  runtime: nodejs6.10
  handler_name: handler
  access_key_id: "$AWS_ACCESS_KEY"
  secret_access_key: "$AWS_SECRET_ACCESS_KEY"
